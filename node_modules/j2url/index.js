var j2url = {

}

j2url.getParam = function(url, paramName) {
  var paramArr = j2url.getParamArr(url);
  var obj = [];
  var res = [];
  paramArr.forEach(function(item) {
    obj = item.split('=');
    
    if(obj[0] === paramName) {
      j2url.isObj(obj[1]) ? res = JSON.parse(obj[1]) : res = obj[1];
    } else if (obj[0].slice(0, obj[0].length - 2) === paramName) {
      res.length > 0 ? res.push(obj[1]) : res = [obj[1]];
    }
  })
  
  return res.length === 0 ? '' : res;
}

j2url.setParam = function(url, paramName, value, encode) {
  var paramArr = j2url.getParamArr(url);
  var isSetted = false;
  var obj = [];
  var res = '';
  paramArr = paramArr.map(function(item) {
    obj = item.split('=');
    if(obj[0] === paramName) {
      obj[1] ? obj[1] = value : obj.push(value);
      isSetted = true;
      
      return obj[0] + '=' + obj[1];
    }
    
    return item;
  })
  
  if(!isSetted) {
    var str = paramName + '=' + value;
    paramArr.push(str);
  }

  paramArr.forEach(function(item) {
    res += (item + '&');
  })
   
  if(encode) return encodeURIComponent(j2url.getUrlOp(url) + '?' + res.substring(0, res.length - 1));
  else return j2url.getUrlOp(url) + '?' + res.substring(0, res.length - 1);
}

j2url.toJson = function(url) {
  var obj = {};
  var temp;
  var paramArr = j2url.getParamArr(url);
  paramArr.forEach(function(item) {
    temp = item.split('=');
    if(j2url.isArr(temp[0])){
      var key = temp[0].slice(0, temp[0].length - 2);
      Object.keys(obj).indexOf(key) > -1 ? obj[key].push(temp[1]) : obj[key] = [temp[1]];
    } else if (j2url.isObj(temp[1])) {
      obj[temp[0]] = JSON.parse(temp[1]);
    } else {
      obj[temp[0]] = (temp[1] ? temp[1] : '');
    }
  })
  
  return obj;
}

j2url.toUrl = function(url, key, json) {
  return url + '?' + key + '=' + JSON.stringify(json);
}

j2url.getParamArr = function(url) {
  var url = decodeURIComponent(url);
  var paramString = (url.split('?')[1] ? url.split('?')[1] : '');
  var paramArr = paramString.split('&');
  
  return paramArr;
}

j2url.getUrlOp = function(url) {
  return url.split('?')[0];
}

j2url.isArr = function(value) {
  return (value.slice(value.length - 2) === '[]');
}

j2url.isObj = function(value) {
  return (value.indexOf('{') === 0 && value.indexOf('}') === value.length -1)
}

if (typeof module !== "undefined" && module.exports) {
  module.exports = j2url;
}
